# dockerfile

FROM nvidia/cuda:12.4.0-runtime-ubuntu22.04

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    DEBIAN_FRONTEND=noninteractive

# Установка системных зависимостей
RUN apt-get update && apt-get install -y \
    python3.11 python3-pip python3.11-venv \
    git curl wget libgl1 libglib2.0-0 libgomp1 libsm6 libxext6 libxrender1 \
    && rm -rf /var/lib/apt/lists/*

# === Установка PyTorch с поддержкой CUDA 12.4 ===
RUN pip3 install --upgrade pip && \
    pip3 install torch==2.4.0 torchvision==0.19.0 torchaudio==2.4.0 \
        --index-url https://download.pytorch.org/whl/cu124

# === Установка PaddlePaddle (последняя стабильная версия 2.6.2) ===
RUN pip3 install paddlepaddle-gpu==2.6.2 \
    -f https://www.paddlepaddle.org.cn/whl/linux/mkl/avx/stable.html

# Установка остальных зависимостей
COPY requirements.txt .
RUN pip3 install -r requirements.txt

WORKDIR /app
COPY . .

# Проверка GPU-совместимости при сборке
RUN python3 -c "
import torch
import paddle
print('✓ PyTorch CUDA:', torch.cuda.is_available())
print('✓ PaddlePaddle CUDA:', paddle.is_compiled_with_cuda())
print('✓ GPU name:', torch.cuda.get_device_name(0) if torch.cuda.is_available() else 'N/A')
"

EXPOSE 8000
CMD ["python3", "app.py"]